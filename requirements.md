# ヘルスチェックアプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Health Check Tool (ヘルスチェックツール)

### 1.2 目的
ネットワークの待ち時間（I/O Wait）を並列化によって解消し、大量のURLの生存確認を短時間で完了させる。

### 1.3 背景
複数のWebサービスやAPIエンドポイントの稼働状況を定期的に監視する必要があるが、逐次実行では時間がかかりすぎる。並列処理を活用することで、効率的なヘルスチェックを実現する。

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 URL入力
- **入力方法1**: コマンドライン引数として複数のURLを指定
  - 例: `healthcheck.exe https://example.com https://api.example.com`
- **入力方法2**: テキストファイルからURLリストを読み込み
  - 1行に1つのURLを記載
  - コメント行（`#`で始まる行）をサポート
  - 空行を無視

#### 2.1.2 並列実行
- 各URLへのHTTP GETリクエストを個別のGoroutineで実行
- 並列度（同時実行数）を設定可能（デフォルト: 10）
- `sync.WaitGroup`を使用して全ての並列処理が完了するまで待機

#### 2.1.3 HTTPリクエスト
- HTTP GETリクエストを送信
- カスタムUser-Agentの設定（デフォルト: "HealthCheck/1.0"）
- リダイレクトの追従（最大3回まで）
- SSL/TLS証明書の検証（オプションで無効化可能）

#### 2.1.4 タイムアウト設定
- 接続タイムアウト: 5秒
- 読み取りタイムアウト: 10秒
- タイムアウト値は設定可能

#### 2.1.5 結果の表示
- URLごとの以下の情報をコンソールに表示:
  - URL
  - HTTPステータスコード（200 OK, 404 Not Foundなど）
  - 応答時間（ミリ秒単位）
  - エラーメッセージ（エラーが発生した場合）
- カラー出力で成功/失敗を視覚的に区別
  - 成功（2xx）: 緑色
  - リダイレクト（3xx）: 黄色
  - クライアントエラー（4xx）: 赤色
  - サーバーエラー（5xx）: 赤色
  - タイムアウト/接続エラー: 赤色

#### 2.1.6 統計情報の表示
- 総リクエスト数
- 成功数（2xxステータスコード）
- 失敗数
- 成功率（%）
- 平均応答時間
- 最小応答時間
- 最大応答時間
- 総実行時間

### 2.2 拡張機能

#### 2.2.1 リトライ機能
- 失敗したリクエストを自動的にリトライ（デフォルト: 3回まで）
- リトライ間隔: 指数バックオフ（1秒、2秒、4秒）
- リトライ回数は設定可能

#### 2.2.2 結果の保存
- JSON形式で結果をファイルに保存（オプション）
- CSV形式で結果をファイルに保存（オプション）
- ログファイルへの出力（オプション）

#### 2.2.3 フィルタリング機能
- 成功したURLのみ表示
- 失敗したURLのみ表示
- 特定のステータスコードのみ表示

#### 2.2.4 進捗表示
- リアルタイムで進捗を表示（例: "5/20 completed"）
- 処理中のURLを表示

#### 2.2.5 設定ファイル
- YAMLまたはJSON形式の設定ファイルをサポート
- タイムアウト値、並列度、リトライ回数などを設定可能

## 3. 非機能要件

### 3.1 パフォーマンス
- 100個のURLを10秒以内にチェック完了（ネットワーク状況による）
- メモリ使用量を最小限に抑える

### 3.2 信頼性
- エラーハンドリングを適切に実装
- パニックを発生させない
- 部分的な失敗でも他のURLのチェックを継続

### 3.3 使いやすさ
- シンプルなコマンドラインインターフェース
- わかりやすいエラーメッセージ
- ヘルプメッセージの提供

### 3.4 保守性
- コードの可読性を重視
- 適切なコメントとドキュメント
- テストコードの作成

## 4. 技術スタック

### 4.1 使用するGoの標準パッケージ
- `net/http`: HTTPリクエストの送信
- `sync`: `sync.WaitGroup`で並列処理の同期
- `time`: 処理時間の計測
- `context`: タイムアウトとキャンセレーションの管理
- `fmt`: フォーマット出力
- `os`: ファイル操作、コマンドライン引数の取得
- `bufio`: ファイルの読み込み
- `encoding/json`: JSON形式での結果保存
- `encoding/csv`: CSV形式での結果保存

### 4.2 外部ライブラリ（オプション）
- カラー出力: `github.com/fatih/color`
- 設定ファイル: `gopkg.in/yaml.v3`（YAMLサポートの場合）
- プログレスバー: `github.com/schollz/progressbar/v3`（進捗表示の場合）

## 5. データ構造

### 5.1 チェック結果
```go
type CheckResult struct {
    URL          string
    StatusCode   int
    ResponseTime time.Duration
    Error        error
    Timestamp    time.Time
}
```

### 5.2 統計情報
```go
type Statistics struct {
    TotalRequests   int
    SuccessCount    int
    FailureCount    int
    SuccessRate     float64
    AvgResponseTime time.Duration
    MinResponseTime time.Duration
    MaxResponseTime time.Duration
    TotalDuration   time.Duration
}
```

## 6. コマンドラインインターフェース

### 6.1 基本的な使用方法
```bash
# コマンドライン引数からURLを指定
healthcheck.exe https://example.com https://api.example.com

# ファイルからURLリストを読み込み
healthcheck.exe -f urls.txt

# 並列度を指定
healthcheck.exe -f urls.txt -c 20

# タイムアウトを指定（秒）
healthcheck.exe -f urls.txt -t 15

# 結果をJSONファイルに保存
healthcheck.exe -f urls.txt -o results.json

# 失敗したURLのみ表示
healthcheck.exe -f urls.txt --filter failed

# ヘルプを表示
healthcheck.exe -h
```

### 6.2 コマンドラインオプション
- `-f, --file`: URLリストファイルのパス
- `-c, --concurrency`: 並列度（デフォルト: 10）
- `-t, --timeout`: タイムアウト秒数（デフォルト: 10）
- `-r, --retries`: リトライ回数（デフォルト: 3）
- `-o, --output`: 出力ファイルのパス（JSON形式）
- `--csv`: CSV形式で結果を保存
- `--filter`: フィルタリング（success/failed/all）
- `--no-color`: カラー出力を無効化
- `--insecure`: SSL証明書の検証をスキップ
- `-v, --verbose`: 詳細なログを出力
- `-h, --help`: ヘルプを表示

## 7. エラーハンドリング

### 7.1 想定されるエラー
- ネットワーク接続エラー
- DNS解決エラー
- タイムアウトエラー
- SSL/TLS証明書エラー
- ファイル読み込みエラー
- 無効なURL形式

### 7.2 エラー処理方針
- 各エラーを適切にキャッチして記録
- エラーメッセージをわかりやすく表示
- 1つのURLでエラーが発生しても他のURLのチェックを継続

## 8. テスト要件

### 8.1 単体テスト
- HTTPリクエスト関数のテスト
- 結果集計関数のテスト
- ファイル読み込み関数のテスト

### 8.2 統合テスト
- モックHTTPサーバーを使用したテスト
- 並列処理の動作確認
- タイムアウト処理の確認

## 9. 実装フェーズ

### Phase 1: 基本機能
- URLリストの読み込み
- 並列HTTPリクエスト
- 基本的な結果表示
- タイムアウト処理

### Phase 2: 拡張機能
- リトライ機能
- 統計情報の表示
- カラー出力
- 結果のファイル保存

### Phase 3: 高度な機能
- 設定ファイルのサポート
- フィルタリング機能
- 進捗表示
- 詳細なログ機能

## 10. 追加で検討すべき要件要素

### 10.1 セキュリティ
- 認証情報のサポート（Basic認証、Bearer Token）
- カスタムヘッダーの設定（APIキーなど）
- 認証情報の安全な管理（環境変数、設定ファイルの暗号化）

### 10.2 監視・アラート
- 失敗率が閾値を超えた場合のアラート
- 応答時間が閾値を超えた場合のアラート
- 外部監視システムへの連携（Prometheus、Grafanaなど）

### 10.3 スケジューリング
- 定期的な実行（cron的な機能）
- 継続的な監視モード

### 10.4 レート制限
- 同一ドメインへのリクエストレート制限
- 全体的なリクエストレート制限

### 10.5 分散実行
- 複数のマシンでの分散実行
- 結果の集約

### 10.6 履歴管理
- 過去のチェック結果の保存
- トレンド分析
- 可用性の履歴レポート
