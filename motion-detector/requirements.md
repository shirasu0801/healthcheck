# 物体検知アプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Motion Detector Application (動体検知アプリケーション)

### 1.2 目的
本プロジェクトの目的は、Raspberry Piに接続されたカメラを通じて、AIにより映像内の動体をリアルタイムで検出し、検出時に指定のアクション（保存、通知など）を実行するシステムを構築することである。

### 1.3 背景
セキュリティ監視、動体検知、自動録画などの用途で、Raspberry Pi上で動作する軽量で効率的な動体検知システムが必要とされている。

## 2. システム構成

### 2.1 ハードウェア
- **Raspberry Pi**: Raspberry Pi 4 または 5
- **カメラ**: Raspberry Pi Camera Module または USBウェブカメラ
- **ストレージ**: SDカードまたは外部ストレージ（録画ファイル保存用）

### 2.2 ソフトウェア
- **OS**: Raspberry Pi OS (Debianベース)
- **開発言語**: Python 3.x
- **主要ライブラリ**:
  - OpenCV: カメラ入力、画像処理、動体検知
  - NumPy: 数値計算
  - PySide6: GUIフレームワーク
  - TensorFlow: AIモデル実行（オプション）

## 3. 機能要件

### 3.1 映像入力・表示機能

#### 3.1.1 カメラ入力
- カメラからの映像をリアルタイムで取得する
- Raspberry Pi Camera Module / USBウェブカメラの両方に対応
- 解像度、フレームレートの設定が可能
- グレースケール処理によるパフォーマンス最適化

#### 3.1.2 映像表示
- 取得した映像をウィンドウ上にリアルタイムで表示する（デバッグ・モニタリング用）
- 検知結果をバウンディングボックスで表示
- ROI（監視領域）の視覚的表示

### 3.2 動体検知エンジン

#### 3.2.1 フレーム差分法
- 連続するフレーム間の差分を計算し、変化があった領域を特定する
- シンプルで高速な検知方法
- ノイズの影響を受けやすい

#### 3.2.2 背景差分法
- 静止した背景モデルと比較し、動体のみを抽出する
- MOG2（Mixture of Gaussians）アルゴリズムを使用
- 適応的背景減算により、照明変化に強い
- 背景モデルのリセット機能

#### 3.2.3 ノイズ除去
- ガウシアンブラー等を用いた平滑化処理を行い、細かいノイズによる誤検知を防止
- モルフォロジー演算（クロージング、オープニング）によるノイズ除去
- 最小面積によるフィルタリング

#### 3.2.4 AI検知（機械学習モデル）
- TensorFlow + COCO事前学習済みモデルを使用
- 「人」や「車」などのオブジェクトを判別可能
- 信頼度スコアによるフィルタリング
- 検知対象クラスの選択が可能

### 3.3 検知エリア設定

#### 3.3.1 ROI設定
- 画面全体ではなく、特定の範囲（ROI: Region of Interest）のみを監視対象に設定できること
- GUI上でマウス操作により矩形選択が可能
- ROI外の動きは無視される

#### 3.3.2 感度調整
- 検知のしきい値（感度）を調整可能にすること
- スライダーによる直感的な操作
- リアルタイムで反映

### 3.4 アクション・出力機能

#### 3.4.1 矩形描画
- 動体を検知した際、対象物を囲む枠（バウンディングボックス）を表示する
- 動体検知: 緑色の矩形
- AI検知: 青色の矩形（オブジェクト名と信頼度を表示）

#### 3.4.2 自動録画・保存
- 動きを検知した際、その前後の映像をmp4形式で保存する
- デフォルト: 検知前5秒 + 検知後5秒（合計10秒）
- ファイル名: `detection_YYYYMMDD_HHMMSS.mp4`
- リングバッファを使用した効率的な実装

#### 3.4.3 ログ記録
- 検知した日時をSQLiteデータベースに記録する
- 記録項目:
  - タイムスタンプ
  - 検知方法（フレーム差分/背景差分/AI検知）
  - 検知オブジェクト（AI検知の場合）
  - 信頼度（AI検知の場合）
  - バウンディングボックス数
  - 録画ファイルパス
- 統計情報の表示（検知回数、最新検知時刻など）
- 日付範囲での検索機能

#### 3.4.4 メール通知
- 検知時にメール通知を送信（オプション）
- SMTPサーバーを使用
- 検知画像または録画ファイルを添付（ファイルサイズ制限あり）
- 検知情報（時刻、方法、オブジェクト）を含む

## 4. 非機能要件

### 4.1 パフォーマンス（Raspberry Pi最適化）

#### 4.1.1 CPU負荷軽減
- 解像度の調整（デフォルト: 640x480）
- グレースケール処理を基本とする
- フレームスキップ（処理負荷が高い場合）
- バッファサイズの最小化

#### 4.1.2 メモリ管理
- リングバッファによる効率的なメモリ使用
- 長時間の稼働でもメモリリークが発生しないこと
- 古い録画ファイルの自動削除（オプション）

### 4.2 自動起動

#### 4.2.1 systemdサービス
- 電源投入後、OSの起動とともにアプリが自動で立ち上がる設定
- systemdサービスファイルによる管理
- 自動再起動機能（クラッシュ時の復旧）

#### 4.2.2 起動スクリプト
- 手動起動用のシェルスクリプト
- サービスインストール用スクリプト

### 4.3 安定性

#### 4.3.1 エラーハンドリング
- カメラ接続エラーの適切な処理
- ファイル保存エラーの処理
- メール送信エラーの処理（通知失敗でも検知は継続）

#### 4.3.2 ログ機能
- ファイルログとコンソールログの両方に対応
- ログレベル（INFO, WARNING, ERROR）の設定
- ログローテーション（オプション）

### 4.4 使いやすさ

#### 4.4.1 GUI
- 直感的な操作インターフェース
- リアルタイムでの設定変更
- 検知ログの表示
- 統計情報の表示

#### 4.4.2 設定ファイル
- JSON形式の設定ファイル
- カメラ、検知、録画、通知などの設定を一元管理
- 設定の動的読み込み（再起動不要）

## 5. 技術仕様

### 5.1 動体検知アルゴリズム

#### 5.1.1 フレーム差分法
- `cv2.absdiff()` を使用して連続フレーム間の差分を計算
- しきい値処理により2値化
- ノイズ除去処理を適用

#### 5.1.2 背景差分法
- `cv2.createBackgroundSubtractorMOG2()` を使用
- 適応的背景モデルによる動体検知
- 影の検出も可能（オプション）

### 5.2 AI検知モデル

#### 5.2.1 TensorFlow + COCO
- TensorFlow HubからCOCO事前学習済みモデルをダウンロード
- MobileNetV2ベースのSSDモデル（軽量でRaspberry Pi向き）
- 80種類のオブジェクトクラスに対応

#### 5.2.2 検知対象クラス
- デフォルト: person, car, bicycle, motorcycle, bus, truck
- 設定により変更可能

### 5.3 録画機能

#### 5.3.1 リングバッファ
- 常に最新N秒（デフォルト: 5秒）のフレームを保持
- 検知時にバッファから録画ファイルを生成
- メモリ効率的な実装

#### 5.3.2 ビデオコーデック
- MP4形式（H.264エンコーディング）
- フレームレート: カメラ設定に依存（デフォルト: 30fps）

### 5.4 データベース

#### 5.4.1 SQLite
- 軽量でRaspberry Piに適したデータベース
- 検知イベントの永続化
- インデックスによる高速検索

#### 5.4.2 テーブル構造
- `detections` テーブル:
  - id (PRIMARY KEY)
  - timestamp (TEXT)
  - detection_method (TEXT)
  - detected_objects (TEXT)
  - confidence (REAL)
  - bbox_count (INTEGER)
  - video_path (TEXT)
  - image_path (TEXT)

## 6. 設定ファイル仕様

### 6.1 config.json

```json
{
  "camera": {
    "device_id": 0,
    "width": 640,
    "height": 480,
    "fps": 30,
    "grayscale": true
  },
  "detection": {
    "method": "background_subtraction",
    "sensitivity": 0.3,
    "roi": null,
    "min_area": 500,
    "enable_ai": true,
    "ai_confidence_threshold": 0.5
  },
  "recording": {
    "enabled": true,
    "pre_seconds": 5,
    "post_seconds": 5,
    "output_dir": "recordings",
    "codec": "mp4v"
  },
  "notification": {
    "enabled": true,
    "email": {
      "smtp_server": "smtp.gmail.com",
      "smtp_port": 587,
      "username": "your_email@gmail.com",
      "password": "your_password",
      "to": "recipient@example.com"
    }
  },
  "database": {
    "path": "data/detections.db"
  }
}
```

### 6.2 設定項目説明

#### 6.2.1 camera
- `device_id`: カメラデバイスID（0がデフォルト）
- `width`: 画像幅（デフォルト: 640）
- `height`: 画像高さ（デフォルト: 480）
- `fps`: フレームレート（デフォルト: 30）
- `grayscale`: グレースケール処理（デフォルト: true）

#### 6.2.2 detection
- `method`: 検知方法（"frame_diff" または "background_subtraction"）
- `sensitivity`: 感度（0.0-1.0、デフォルト: 0.3）
- `roi`: 監視領域 [x, y, width, height]（nullの場合は全体）
- `min_area`: 検知する最小面積（ピクセル、デフォルト: 500）
- `enable_ai`: AI検知を有効化（デフォルト: true）
- `ai_confidence_threshold`: AI検知の信頼度しきい値（0.0-1.0、デフォルト: 0.5）

#### 6.2.3 recording
- `enabled`: 録画を有効化（デフォルト: true）
- `pre_seconds`: 検知前の録画秒数（デフォルト: 5）
- `post_seconds`: 検知後の録画秒数（デフォルト: 5）
- `output_dir`: 出力ディレクトリ（デフォルト: "recordings"）
- `codec`: ビデオコーデック（デフォルト: "mp4v"）

#### 6.2.4 notification
- `enabled`: 通知を有効化（デフォルト: true）
- `email`: メール設定
  - `smtp_server`: SMTPサーバーアドレス
  - `smtp_port`: SMTPポート番号
  - `username`: SMTP認証ユーザー名
  - `password`: SMTP認証パスワード
  - `to`: 送信先メールアドレス

#### 6.2.5 database
- `path`: データベースファイルのパス（デフォルト: "data/detections.db"）

## 7. インストールとセットアップ

### 7.1 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 7.2 設定ファイルの編集

1. `config.json` を編集して、カメラ設定、メール設定などを構成
2. メール通知を使用する場合、SMTP認証情報を設定

### 7.3 実行

#### 7.3.1 手動実行
```bash
python3 main.py
```

#### 7.3.2 自動起動設定
```bash
chmod +x install_service.sh
./install_service.sh
sudo systemctl start motion-detector
```

## 8. 使用方法

### 8.1 GUI操作

1. アプリケーションを起動
2. 「開始」ボタンをクリックして検知を開始
3. 必要に応じて設定を調整:
   - 検知方法の選択
   - 感度の調整
   - ROIの設定（マウスで矩形選択）
   - AI検知の有効/無効
   - 録画の有効/無効
   - メール通知の有効/無効
4. 検知ログと統計情報を確認

### 8.2 背景リセット

- カメラの位置や照明条件が変更された場合、「背景リセット」ボタンをクリック
- 新しい背景モデルが構築される

## 9. トラブルシューティング

### 9.1 カメラが開けない
- カメラが正しく接続されているか確認
- 他のアプリケーションがカメラを使用していないか確認
- `device_id` を変更して試す

### 9.2 AI検知が動作しない
- TensorFlowが正しくインストールされているか確認
- インターネット接続を確認（モデルのダウンロードに必要）
- ログファイルでエラーを確認

### 9.3 メール通知が送信されない
- SMTP設定が正しいか確認
- ファイアウォールでSMTPポートがブロックされていないか確認
- Gmailを使用する場合、アプリパスワードの設定が必要な場合がある

## 10. 今後の拡張予定

### 10.1 機能追加
- 複数カメラ対応
- クラウドストレージへの自動アップロード
- LINE通知、Slack通知の追加
- Webダッシュボードの実装

### 10.2 パフォーマンス改善
- TensorFlow Liteへの移行（より軽量）
- マルチスレッド処理の最適化
- GPUアクセラレーション（Raspberry Pi 5対応）

### 10.3 セキュリティ強化
- 設定ファイルの暗号化
- 認証機能の追加
- リモートアクセス制御
